name: ci

on:
  pull_request:
    branches: [master]
  push:
    branches: [master]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-go@v2
      with: {go-version: ^1}
    - run: |
        make test
  generate:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-go@v2
      with: {go-version: ^1}
    - run: |
        make clean
        make generate
    - name: Check if there's any changes
      if: success()
      run: |
        modified="$(git ls-files --modified)"
        untracked="$(git ls-files --exclude-standard --others)"
        if [ -n "$modified" ] || [ -n "$untracked" ]; then
            echo "Modified:"
            echo "$modified"
            echo
            echo "Untracked:"
            echo "$untracked"

            git diff
            exit 1
        fi
