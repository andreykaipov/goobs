name: Update OBS websocket protocol version

on:
  workflow_dispatch:
  schedule:
    - cron: 0 0 * * *

jobs:
  update:
    name: update protocol version
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: update version
      id: update
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        ./script/bump-protocol-version.sh
        version=$(grep obs_websocket_protocol_version version.go | tr -dc '0-9.')
        message="Bump OBS websocket protocol to $version."
        echo "message=$message" >>$GITHUB_OUTPUT

        workflow_slug=$(echo "${{ github.workflow }}" | sed 's/ /+/g')
        workflow_link="${{ github.server_url }}/${{ github.repository }}/actions?query=workflows:$workflow_slug"
        link="This PR is generated by the _[${{ github.workflow }} workflow]($workflow_link)_."
        echo "link=$link" >>$GITHUB_OUTPUT

    - name: create pr
      uses: peter-evans/create-pull-request@v5
      with:
        title: ${{ steps.update.outputs.message }}
        commit-message: ${{ steps.update.outputs.message }}
        branch: feature/bump-protocol-version
        delete-branch: true
        labels: |
          feature
        reviewers: |
          andreykaipov
        body: >
          ${{ steps.update.outputs.link }}
          <br>

          There was a new v5 tag in [obsproject/obs-websocket](https://github.com/obsproject/obs-websocket).
          This PR may or may not contain any actual changes to the generated code.
